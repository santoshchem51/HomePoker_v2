# Story 3.4: Multi-Phase Settlement Support

## Status
**Draft - Future Epic** (Deferred due to Epic 3 scope rollback)

**SCOPE NOTICE:** This story was originally approved but has been deferred to maintain Epic 3 scope rollback integrity. Story 3.5 successfully eliminated multi-phase settlement types as "scope creep" to restore Epic 3 to its original PRD intent. This story should be considered for a future epic focused on advanced settlement features.

## Story
**As a** poker game with players leaving at different times,
**I want** settlement calculations that handle multiple cash-out phases,
**so that** early leavers can settle while others continue playing.

## Acceptance Criteria
1. Partial settlements process without affecting ongoing game
2. Remaining pot recalculates after each early cash-out
3. Settlement history tracks all intermediate calculations
4. Final settlement accounts for all previous partial settlements
5. Clear visualization of settlement phases and remaining players
6. Rollback capability if early settlement needs correction

## Tasks / Subtasks

### Task 1: Implement Multi-Phase Settlement Data Model (AC: 1, 2, 3)
- [ ] Add settlement_phases table to database schema
  - [ ] Create table with phase_id, session_id, phase_number, timestamp fields
  - [ ] Add phase_type enum: 'early_cashout' | 'final_settlement'
  - [ ] Add phase_status: 'pending' | 'completed' | 'rolled_back'
- [ ] Extend settlement types with multi-phase support
  - [ ] Create SettlementPhase interface
  - [ ] Add phaseHistory array to OptimizedSettlement
  - [ ] Create PhaseTransition interface for tracking state changes
- [ ] Update existing settlement tracking
  - [ ] Modify PlayerSettlement to include phase_id reference
  - [ ] Add remaining_players count to each phase
  - [ ] Track cumulative_settlements per player across phases

### Task 2: Create Partial Settlement Calculator (AC: 1, 2)
- [ ] Implement calculatePartialSettlement() method
  - [ ] Accept early cashout request with player and chip count
  - [ ] Calculate player's net position at time of cashout
  - [ ] Determine settlement amount from remaining bank
- [ ] Implement adjustRemainingPot() method
  - [ ] Subtract settled amount from total pot
  - [ ] Recalculate remaining player percentages
  - [ ] Update bank balance after partial payout
- [ ] Add validation for partial settlements
  - [ ] Ensure sufficient bank balance for payout
  - [ ] Validate player hasn't already cashed out
  - [ ] Check for active game status

### Task 3: Build Settlement Phase Tracking System (AC: 3, 4)
- [ ] Create SettlementPhaseService
  - [ ] Implement createNewPhase() for phase initialization
  - [ ] Add recordPhaseSettlement() to persist phase data
  - [ ] Create getPhaseHistory() for retrieving all phases
- [ ] Implement phase transition logic
  - [ ] Track phase_number incrementally
  - [ ] Link phases with parent_phase_id
  - [ ] Calculate cumulative effects across phases
- [ ] Add audit trail for each phase
  - [ ] Record who initiated the phase
  - [ ] Track all players involved in each phase
  - [ ] Store calculation snapshots for each phase

### Task 4: Develop Final Settlement Reconciliation (AC: 4)
- [ ] Create reconcileFinalSettlement() method
  - [ ] Aggregate all previous partial settlements
  - [ ] Calculate final positions for remaining players
  - [ ] Account for all phase transitions in final calculation
- [ ] Implement settlement verification
  - [ ] Validate total in equals total out across all phases
  - [ ] Cross-check player totals with phase history
  - [ ] Ensure no duplicate settlements
- [ ] Add final settlement report generation
  - [ ] Include all phase summaries
  - [ ] Show cumulative player movements
  - [ ] Provide complete transaction audit

### Task 5: Create Phase Visualization Components (AC: 5)
- [ ] Build SettlementPhaseTimeline component
  - [ ] Display chronological phase progression
  - [ ] Show players involved in each phase
  - [ ] Indicate settlement amounts per phase
- [ ] Create RemainingPlayersDisplay component
  - [ ] Show current active players after each phase
  - [ ] Display updated pot size
  - [ ] Indicate next potential settlement scenarios
- [ ] Add PhaseDetailsModal component
  - [ ] Show detailed breakdown of specific phase
  - [ ] Display calculation steps for that phase
  - [ ] Allow drilling into player-specific details

### Task 6: Implement Settlement Rollback Mechanism (AC: 6)
- [ ] Create rollbackSettlementPhase() method
  - [ ] Reverse the financial effects of a phase
  - [ ] Restore previous pot and player states
  - [ ] Mark phase as rolled_back in database
- [ ] Add rollback validation
  - [ ] Ensure only most recent phase can be rolled back
  - [ ] Prevent rollback if subsequent phases exist
  - [ ] Validate user has permission to rollback
- [ ] Implement rollback UI controls
  - [ ] Add rollback button with confirmation dialog
  - [ ] Show rollback history and reasons
  - [ ] Display restored state after rollback

### Task 7: Add Multi-Phase Integration to Existing Services (AC: 1, 2, 3, 4)
- [ ] Update SettlementService
  - [ ] Integrate phase tracking into calculateEarlyCashOut()
  - [ ] Modify optimizeSettlement() to consider phases
  - [ ] Update validateSettlement() for multi-phase scenarios
- [ ] Enhance TransactionService
  - [ ] Link transactions to settlement phases
  - [ ] Add phase_id to transaction records
  - [ ] Support phase-specific transaction queries
- [ ] Update SessionService
  - [ ] Add phase state to session status
  - [ ] Track active_phase_id in session
  - [ ] Support phase-aware session queries

### Task 8: Unit Testing for Multi-Phase Settlements (70% Coverage)
- [ ] Unit tests for phase calculations
  - [ ] Test partial settlement accuracy
  - [ ] Verify pot recalculation logic
  - [ ] Validate phase transition states
- [ ] Unit tests for phase service methods
  - [ ] Test createNewPhase() functionality
  - [ ] Verify rollback mechanisms in isolation
  - [ ] Test edge cases (zero settlement amounts, invalid phases)
- [ ] Component unit tests for phase visualization
  - [ ] Test timeline component rendering with mock data
  - [ ] Verify phase details display with sample props
  - [ ] Test rollback UI interactions with mocked callbacks

## Dev Notes

### Previous Story Context
From Story 3.3 (Settlement Validation - Simplified):
- Basic settlement validation implemented in SettlementService
- validateSettlement() method provides mathematical balance checking
- Simplified audit trail generation already in place
- Note: Story 3.3 was successfully simplified as part of Epic 3 scope rollback, removing complex features

### Database Schema Requirements
[Source: architecture/database-schema.md]

**New Table Required: settlement_phases**
```sql
CREATE TABLE settlement_phases (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    phase_number INTEGER NOT NULL,
    phase_type TEXT CHECK(phase_type IN ('early_cashout', 'final_settlement')) NOT NULL,
    phase_status TEXT CHECK(phase_status IN ('pending', 'completed', 'rolled_back')) NOT NULL DEFAULT 'pending',
    initiated_by TEXT NOT NULL, -- Device identifier
    initiated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME,
    rolled_back_at DATETIME,
    rollback_reason TEXT,
    
    -- Financial tracking
    pot_before DECIMAL(10,2) NOT NULL,
    pot_after DECIMAL(10,2) NOT NULL,
    settled_amount DECIMAL(10,2) NOT NULL,
    remaining_players INTEGER NOT NULL,
    
    -- Audit
    calculation_snapshot TEXT, -- JSON of calculation details
    parent_phase_id TEXT REFERENCES settlement_phases(id),
    
    -- Indexes
    INDEX idx_phases_session ON settlement_phases(session_id, phase_number),
    INDEX idx_phases_status ON settlement_phases(phase_status),
    INDEX idx_phases_type ON settlement_phases(session_id, phase_type)
);
```

**Modifications to existing tables:**
- Add phase_id to transactions table for phase linkage
- Add active_phase_id to sessions table for current phase tracking

### Service Architecture Integration
[Source: architecture/backend-architecture.md]

**Service Layer Location:** src/services/settlement/
- Enhance existing SettlementService.ts with multi-phase methods
- Create new SettlementPhaseService.ts for phase-specific logic
- Follow singleton pattern consistent with other services

**Transaction Safety Requirements:**
- All phase operations must use DatabaseService.executeTransaction()
- Rollback operations require complete transaction reversal
- Phase transitions must be atomic operations

### Type Definitions Required
[Source: architecture/unified-project-structure.md - Types location: src/types/]

**New interfaces to add to settlement.ts:**
```typescript
export interface SettlementPhase {
  id: string;
  sessionId: string;
  phaseNumber: number;
  phaseType: 'early_cashout' | 'final_settlement';
  phaseStatus: 'pending' | 'completed' | 'rolled_back';
  initiatedBy: string;
  initiatedAt: string;
  completedAt?: string;
  potBefore: number;
  potAfter: number;
  settledAmount: number;
  remainingPlayers: number;
  playerSettlements: PlayerSettlement[];
  calculationSnapshot?: any;
  parentPhaseId?: string;
}

export interface PhaseTransition {
  fromPhase: SettlementPhase;
  toPhase: SettlementPhase;
  transitionType: 'cashout' | 'final' | 'rollback';
  affectedPlayers: string[];
  financialImpact: number;
}

export interface MultiPhaseSettlement extends OptimizedSettlement {
  phases: SettlementPhase[];
  currentPhaseId: string;
  totalPhases: number;
  hasPartialSettlements: boolean;
}
```

### Component Architecture
[Source: architecture/components.md, architecture/unified-project-structure.md]

**New Components Location:** src/components/settlement/
- SettlementPhaseTimeline.tsx - Timeline visualization component
- RemainingPlayersDisplay.tsx - Active players after phases
- PhaseDetailsModal.tsx - Detailed phase breakdown modal
- SettlementRollbackDialog.tsx - Rollback confirmation UI

**Component Integration:**
- Components should use settlementStore from src/stores/
- Follow existing React Native component patterns
- Use TouchableOpacity, ScrollView, and React Native UI elements
- Apply existing theme from src/styles/theme.ts

### State Management Integration
[Source: Existing settlementStore.ts patterns]

**Store Enhancements Required:**
- Add phases array to settlement state
- Add currentPhaseId tracking
- Add phase mutation actions (createPhase, completePhase, rollbackPhase)
- Maintain immutability using Zustand patterns

### Financial Calculation Requirements
[Source: architecture/coding-standards.md]

**Critical Rules:**
- NEVER use floating-point arithmetic directly
- All currency calculations must maintain cent precision
- Use existing calculation patterns from SettlementService
- Every multi-phase calculation must balance to exactly $0.00

### Error Handling Requirements
[Source: Existing ServiceError patterns]

**New Error Codes to Add:**
```typescript
export type SettlementErrorCode = 
  | existing_codes...
  | 'PHASE_CREATION_FAILED'
  | 'PARTIAL_SETTLEMENT_FAILED'  
  | 'PHASE_ROLLBACK_FAILED'
  | 'INSUFFICIENT_FUNDS_FOR_PHASE'
  | 'INVALID_PHASE_TRANSITION'
  | 'PHASE_RECONCILIATION_FAILED';
```

### Performance Considerations
[Source: architecture/security-and-performance.md]

**Multi-Phase Performance Impact:**
- Phase calculations should complete within existing 2-second settlement requirement
- Database queries optimized with proper indexing on settlement_phases table
- Memory usage for phase history should remain within app limits
- Consider lazy loading for extensive phase history displays

### Migration Strategy for Existing Settlements
**Backward Compatibility:**
- Existing single-phase settlements continue to work unchanged
- Multi-phase features are opt-in when early cashouts occur
- No migration of historical settlement data required
- Phase tracking starts fresh with new sessions

### Monitoring and Logging Requirements
**Phase Operation Logging:**
- Log all phase transitions with timestamps and player counts
- Track rollback operations with reasons for audit purposes
- Monitor phase calculation performance for optimization
- Include phase information in settlement export logs

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test Coverage Requirements:**
- Service Layer: 70% minimum coverage for phase calculations
- Component Coverage: 70% minimum for new UI components  
- Focus on unit tests only - no integration dependencies required
- Edge Cases: Test phase transition scenarios in isolation

**Test File Locations:**
- Service tests: tests/__tests__/services/settlement/SettlementPhaseService.test.ts
- Component tests: tests/__tests__/components/settlement/PhaseComponents.test.tsx
- No integration test files required

**Critical Test Scenarios (Unit Tests Only):**
1. Single early cashout calculation in isolation
2. Multiple sequential early cashout calculations
3. Phase rollback logic without database dependencies
4. Final settlement calculation with mock phase history
5. Edge case: Phase with zero settlement amount
6. Edge case: Invalid phase transition attempts
7. Component rendering with various phase states

### Implementation Priority Notes
Given Epic 3's scope rollback context:
1. Keep implementation simple and focused on core functionality
2. Avoid scope creep - no complex visualizations or advanced features
3. Focus on mathematical accuracy and data integrity
4. Ensure backward compatibility with existing settlement features
5. Multi-phase should be optional - games without early cashouts work unchanged

### Technical Constraints
[Source: architecture/tech-stack.md, CLAUDE.md]
- React Native 0.73+ with TypeScript 5.3+
- SQLite with WAL mode for database operations
- Zustand 4.4+ for state management
- No external API calls - all processing local
- Must work completely offline
- 30-second undo window for phase operations (matching transaction undo)

## Testing

**Test Standards:**
- All multi-phase calculations must be tested with known scenarios using mocked data
- Phase transitions must be tested in isolation without database dependencies
- Rollback scenarios must test logic only, not data persistence
- UI components must be tested with React Native Testing Library using mock props
- 70% coverage target for both service and component tests

**Test File Organization:**
- Unit tests in tests/__tests__/services/settlement/
- Component tests in tests/__tests__/components/settlement/
- Test fixtures with mock data in tests/fixtures/multiPhaseScenarios.json
- No integration test directory needed

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-14 | 1.0 | Created Multi-Phase Settlement Support story | Bob (SM) |
| 2025-08-14 | 1.1 | Updated with performance, migration, and monitoring requirements. Reduced test coverage to 70% and removed integration dependencies | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent during implementation*

### Debug Log References
*To be populated by development agent during implementation*

### Completion Notes List
*To be populated by development agent during implementation*

### File List
*To be populated by development agent during implementation*

## QA Results
*To be populated during QA review*